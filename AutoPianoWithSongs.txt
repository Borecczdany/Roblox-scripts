-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- GUI setup
local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.Name = "AutoPianoPlayerGui"
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 350, 0, 420)
mainFrame.Position = UDim2.new(0.5, -175, 0.5, -210)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true

-- Title
local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundTransparency = 1
title.Text = "Auto Piano Player (Letter+Timing)"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 22

-- Instruction label
local instr = Instance.new("TextLabel", mainFrame)
instr.Size = UDim2.new(1, -20, 0, 40)
instr.Position = UDim2.new(0, 10, 0, 40)
instr.BackgroundTransparency = 1
instr.Text = "Chat input blocked while playing"
instr.TextColor3 = Color3.new(1, 1, 1)
instr.Font = Enum.Font.SourceSans
instr.TextSize = 16
instr.TextWrapped = true

-- Songs data, each song is {notes = "ASDF", timings = {0.5, 0.3, 0.7, 0.4}}
local songs = {
    ["Moonlight Sonata 3rd"] = {
        notes = "ASDFGHJ",
        timings = {0.3, 0.2, 0.5, 0.4, 0.6, 0.3, 0.4}
    },
    ["Golden Hour"] = {
        notes = "WERTE",
        timings = {0.4, 0.6, 0.5, 0.7, 0.3}
    }
}

local playing = false
local currentCoroutine

-- Function to press and release key using VirtualInputManager
local function pressKey(key)
    if not VirtualInputManager then return end
    VirtualInputManager:SendKeyEvent(true, key, false, game)
    wait(0.05)
    VirtualInputManager:SendKeyEvent(false, key, false, game)
end

-- Block chat input
local blockConnection
local function blockChatInput(enable)
    if enable then
        blockConnection = UserInputService.TextBoxFocused:Connect(function()
            if playing then
                playerGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false)
            end
        end)
        playerGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, false)
    else
        if blockConnection then
            blockConnection:Disconnect()
            blockConnection = nil
        end
        playerGui:SetCoreGuiEnabled(Enum.CoreGuiType.Chat, true)
    end
end

-- Play song function
local function playSong(song)
    playing = true
    blockChatInput(true)

    local notes = song.notes
    local timings = song.timings

    for i = 1, #notes do
        if not playing then break end
        local key = notes:sub(i, i)
        pressKey(key)
        local waitTime = timings[i] or 0.4
        wait(waitTime)
    end

    blockChatInput(false)
    playing = false
end

local function stopPlaying()
    playing = false
    blockChatInput(false)
end

-- Buttons setup
local buttonY = 90
for songName, _ in pairs(songs) do
    local btn = Instance.new("TextButton", mainFrame)
    btn.Size = UDim2.new(1, -20, 0, 40)
    btn.Position = UDim2.new(0, 10, 0, buttonY)
    btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 20
    btn.Text = "Play: "..songName
    btn.AutoButtonColor = true

    btn.MouseButton1Click:Connect(function()
        if playing then stopPlaying() end
        currentCoroutine = coroutine.create(function()
            playSong(songs[songName])
        end)
        coroutine.resume(currentCoroutine)
    end)
    buttonY = buttonY + 50
end

-- Stop button
local stopBtn = Instance.new("TextButton", mainFrame)
stopBtn.Size = UDim2.new(1, -20, 0, 40)
stopBtn.Position = UDim2.new(0, 10, 0, buttonY)
stopBtn.BackgroundColor3 = Color3.fromRGB(150, 20, 20)
stopBtn.TextColor3 = Color3.new(1, 1, 1)
stopBtn.Font = Enum.Font.SourceSansBold
stopBtn.TextSize = 20
stopBtn.Text = "Stop"

stopBtn.MouseButton1Click:Connect(function()
    stopPlaying()
end)
